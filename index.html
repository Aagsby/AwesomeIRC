<link rel="stylesheet" href="styles.css">
<link href='http://fonts.googleapis.com/css?family=Quicksand' rel='stylesheet' type='text/css'>



<div id="chat">
	<div id="messages">
	</div>

	<div id="users">
	</div>

	<form id="chatInput">
		<input type="text" id="Message">
		<input type="submit" id="sendMessage" value="sendMessage">
	</form>
</div>

<div id="waiting">
	<div class="spinner"></div>
</div>

<div id="login">
	<div id="verticalBar">
		<form id="nameInput">
			<h3>Enter your nickname:</h3>
			<input type="text" id="Nickname">
			<div id="submitName" value="Choose Nick!">Submit Name!</div>
		</form>
	</div>
</div>

<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

<script>

var irc = require('irc');
var client = null;
var users = [];

$('#nameInput').on('submit',function(e){
	e.preventDefault();
	$('#submitName').trigger('click');
});

$('#submitName').on('click',function(){

	var name = $('#Nickname').val().toString();
	var url = 'chat.freenode.org';
	var opts = {
		    channels: ['#schnitzelwirt'],
		};

	if(name.length > 0){
		client = new irc.Client(url, name, opts);
		addRegistrationHandler();

		$('#login').css('top','-100%');
		addMessageToList('client','You','Please wait untill we have connected you.')
	}	
});

function addRegistrationHandler(){
	client.on('registered',function(){

		client.on('error',function(e){
			console.log(e);
		});

		$('#chatInput').on('submit',function(e){
			e.preventDefault();
			sendMessage();
		});

		addMessageHandler();
		addNamesHandler();

	});
}

function drawNamesList(){
	$('#users').empty();
	users.forEach(function(u){
		$('#users').append('<p class="nickname">' + u + '</p>');
	});
}

function addNamesHandler(){

	client.on('join',function(channel,name){
		addMessageToList('client','You',name + ' has entered the channel ' + channel + '.');
		users.push(name);
		drawNamesList();
	});

	client.on('quit',function(name,reason,channel){
		addMessageToList('client','You',name + ' has left the channel ' + channel + '.');
		var index = users.indexOf(name);
		if(index > -1){
			users.splice(index,1);
		}
		
		drawNamesList();
		
	});

	client.once('names#schnitzelwirt',function(nicks){
		users = [];
			for(var key in nicks){
				users.push(key);
			}
			$('#waiting').css('top','-100%');
			drawNamesList();
	});
}

function addMessageHandler(){
	client.on('message', function (from, to, message) {
		addMessageToList(from,to,message);
	});
}

function sendMessage(){
	message = $('#Message').val();
	if(message.length > 0){
		client.say('#schnitzelwirt',message)
		addMessageToList('You','#schnitzelwirt',message);
		$('#Message').val('');
	}	
}

function addMessageToList(from, to, message){
	message = escapeHTML.apply(message);
	$('#messages').append('<p>'+ from + ' => ' + to + ': ' + message +'</p>');
	$('#messages').scrollTop($('#messages').get(0).scrollHeight)
}

function escapeHTML() {
    return this.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

</script>